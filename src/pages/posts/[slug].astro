---
import fs from 'node:fs';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const posts = (await getCollection('posts')).filter((item) => !item.data.draft);
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

type Props = {
  post: CollectionEntry<'posts'>;
};

const { post } = Astro.props as Props;
const { Content } = await post.render();

const formatDateTime = (date: Date) =>
  new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
  }).format(date);

const getTimes = async () => {
  try {
    const fileUrl = new URL(`../../content/${post.collection}/${post.id}`, import.meta.url);
    const stats = await fs.promises.stat(fileUrl);
    return { createdAt: stats.birthtime, updatedAt: stats.mtime };
  } catch (err) {
    const fallback = post.data.publishedAt ?? new Date();
    return { createdAt: fallback, updatedAt: fallback };
  }
};

const times = await getTimes();
---

<BaseLayout title={`${post.data.title} Â· Posts`} description={post.data.description}>
  <article class="article panel">
    <p class="muted">{formatDateTime(times.updatedAt)}</p>
    <h1>{post.data.title}</h1>
    {post.data.tags.length > 0 && (
      <div class="tags">
        {post.data.tags.map((tag) => (
          <span class="tag">{tag}</span>
        ))}
      </div>
    )}
    <div class="content">
      <Content />
    </div>
  </article>
</BaseLayout>

<style>
  .article h1 {
    margin: 0.2em 0 0.1em;
  }

  .content :global(img) {
    max-width: 100%;
    border-radius: 12px;
  }

  .content :global(code) {
    background: rgba(255, 255, 255, 0.06);
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 0.95rem;
  }

  .content :global(pre) {
    background: #0b0f16;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    overflow-x: auto;
  }

  .tags {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin: 10px 0 14px;
  }

  .tag {
    display: inline-flex;
    align-items: center;
    border-radius: 999px;
    padding: 4px 10px;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid var(--border);
    color: var(--muted);
    font-size: 0.85rem;
  }

  .muted {
    color: var(--muted);
  }
</style>
